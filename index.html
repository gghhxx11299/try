<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ethiopia Agri MVP</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body style="margin:0; font-family:sans-serif;">
  <h2 style="padding:10px; background:#eee;">Ethiopia Agricultural Dashboard (MVP)</h2>

  <div style="display:flex; flex-wrap:wrap; height:90vh;">
    <!-- Sidebar -->
    <div id="sidebar" style="width:300px; padding:10px; overflow-y:auto; background:#f9f9f9; border-right:1px solid #ccc;">
      <h3>Crop Filter</h3>
      <button class="crop-btn active" data-crop="all">All Crops</button><br><br>
      <button class="crop-btn" data-crop="teff">Teff</button><br>
      <button class="crop-btn" data-crop="maize">Maize</button><br>
      <button class="crop-btn" data-crop="wheat">Wheat</button><br>
      <button class="crop-btn" data-crop="coffee">Coffee</button><br><br>

      <h3>Weather Layers</h3>
      <button class="weather-btn" data-layer="rainfall">Rainfall</button><br>
      <button class="weather-btn" data-layer="temperature">Temperature</button><br><br>

      <div id="region-info">
        <h3>Region: <span id="region-name">None</span></h3>
        <p>Yield: <span id="yield-value">-</span> t/ha</p>
        <p>Rainfall: <span id="rainfall-value">-</span> mm</p>
        <p>Temp: <span id="temp-value">-</span> Â°C</p>

        <canvas id="yield-chart" height="100"></canvas>
        <canvas id="rainfall-chart" height="100"></canvas>
      </div>
    </div>

    <!-- Map -->
    <div id="map" style="flex:1; min-height:400px;"></div>
  </div>

  <script>
    // Simulated region data with crop + weather
    const regions = {
      type: "FeatureCollection",
      features: [
        {
          type: "Feature",
          properties: {
            name: "Oromia",
            cropYields: { all: 7.5, teff: 7.2, maize: 7.8, wheat: 7.0, coffee: 8.0 },
            cropWeather: {
              all: { rainfall: 950, temp: 20 },
              teff: { rainfall: 900, temp: 21 },
              maize: { rainfall: 920, temp: 22 },
              wheat: { rainfall: 880, temp: 19 },
              coffee: { rainfall: 1200, temp: 24 }
            }
          },
          geometry: { type: "Polygon", coordinates: [[[34.5,4.5],[42.5,4.5],[42.5,10.5],[34.5,10.5],[34.5,4.5]]] }
        },
        {
          type: "Feature",
          properties: {
            name: "Amhara",
            cropYields: { all: 8.2, teff: 8.5, maize: 8.0, wheat: 8.3, coffee: 0 },
            cropWeather: {
              all: { rainfall: 1100, temp: 16 },
              teff: { rainfall: 1150, temp: 15 },
              maize: { rainfall: 1050, temp: 17 },
              wheat: { rainfall: 1120, temp: 14 },
              coffee: { rainfall: 0, temp: 0 }
            }
          },
          geometry: { type: "Polygon", coordinates: [[[35.5,12.5],[39.8,12.5],[39.8,9.5],[35.5,9.5],[35.5,12.5]]] }
        }
      ]
    };

    // Map setup
    const map = L.map('map').setView([9.145, 40.4897], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let currentCrop = 'all';
    let geoLayer;

    function getColor(yield) {
      return yield > 8 ? '#1B5E20' : yield > 6 ? '#4CAF50' : yield > 4 ? '#FFC107' : '#FF5722';
    }

    function getRegionData(feature, crop) {
      const props = feature.properties;
      const yield = crop === 'all' ? props.cropYields.all : props.cropYields[crop] || props.cropYields.all;
      const weather = crop === 'all' ? props.cropWeather.all : props.cropWeather[crop] || props.cropWeather.all;
      return { yield, ...weather };
    }

    function updateMap() {
      if (geoLayer) map.removeLayer(geoLayer);
      geoLayer = L.geoJSON(regions, {
        style: f => ({ fillColor: getColor(getRegionData(f, currentCrop).yield), weight: 1, fillOpacity: 0.7 }),
        onEachFeature: (f, layer) => {
          layer.on('click', () => {
            const data = getRegionData(f, currentCrop);
            document.getElementById('region-name').textContent = f.properties.name;
            document.getElementById('yield-value').textContent = data.yield;
            document.getElementById('rainfall-value').textContent = data.rainfall;
            document.getElementById('temp-value').textContent = data.temp;

            // Update charts
            yieldChart.data.datasets[0].data = [data.yield*0.8, data.yield*0.9, data.yield];
            rainfallChart.data.datasets[0].data = [data.rainfall*0.3, data.rainfall*0.6, data.rainfall];
            yieldChart.update();
            rainfallChart.update();
          });
        }
      }).addTo(map);
    }

    // Charts
    const yieldCtx = document.getElementById('yield-chart').getContext('2d');
    const yieldChart = new Chart(yieldCtx, {
      type: 'line',
      data: { labels: ['2022','2023','2024'], datasets: [{ label: 'Yield', data: [0,0,0], borderColor: 'blue' }] },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
    });

    const rainCtx = document.getElementById('rainfall-chart').getContext('2d');
    const rainfallChart = new Chart(rainCtx, {
      type: 'bar',
      data: { labels: ['Q1','Q2','Q3'], datasets: [{ label: 'Rainfall', data: [0,0,0], backgroundColor: 'rgba(54,162,235,0.6)' }] },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
    });

    // Crop buttons
    document.querySelectorAll('.crop-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.crop-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentCrop = btn.dataset.crop;
        updateMap();
      });
    });

    // Weather buttons (UI only)
    document.querySelectorAll('.weather-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        btn.classList.toggle('active');
        alert(`Weather layer "${btn.dataset.layer}" toggled`);
      });
    });

    // Init
    updateMap();
  </script>
</body>
</html>